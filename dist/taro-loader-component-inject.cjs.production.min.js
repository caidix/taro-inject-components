"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var n=require("loader-utils"),t=require("@tarojs/helper"),r=require("minimatch"),i=require("crypto"),o=require("fs"),a=require("path"),s=e(require("@babel/generator")),c=e(require("@babel/parser")),u=e(require("@babel/traverse")),l=e(require("@babel/types")),p=e(require("@babel/template"));function f(){return(f=Object.assign?Object.assign.bind():function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e}).apply(this,arguments)}function d(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=new Array(n);t<n;t++)r[t]=e[t];return r}function m(e,n){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(t)return(t=t.call(e)).next.bind(t);if(Array.isArray(e)||(t=function(e,n){if(e){if("string"==typeof e)return d(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?d(e,void 0):void 0}}(e))||n&&e&&"number"==typeof e.length){t&&(e=t);var r=0;return function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var v,g={enable:!1,includePages:[],excludePages:[],componentsPath:a.resolve(process.cwd(),"src/_inject")},x={entry:"index.tsx",injectPosition:"bottom",includePages:[],excludePages:[],enable:!0},y=process.env.TARO_ENV||"",b={webView:!0},h=function(e,n){return!(!e||!e.length||!e.find((function(e){return r.minimatch(n,e)})))},j=function(e,n){return!e||!e.length||!!e.find((function(e){return r.minimatch(n,e)}))},_=function(e,n){var t=e.excludePages,r=void 0===t?[]:t,i=e.includePages,o=void 0===i?[]:i,a=e.injectEnv;return"string"==typeof a&&(a=[a]),!(!a||!a.length||a.includes(y))||!!h(r,n)||!j(o,n)},E=function(e){var n=i.createHash("md5");return n.update(e,"utf8"),n.digest("hex")},S=function(e){try{return e.replace(/[_-](\w)/g,(function(e,n){return n.toUpperCase()})).replace(/^.*?(\w)/,(function(e,n){return n.toUpperCase()})).replace(/[^a-zA-Z]/g,"")}catch(n){return console.log("转换 "+e+" 默认组件名称失败: "+n),"InjectGlobalComp"+function(e){for(var n="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",t=n.length,r="",i=0;i<4;i++)r+=n.charAt(Math.floor(Math.random()*t));return r+""+(new Date).getTime()}()}},O=function(e){return l.jSXElement(l.jSXOpeningElement(l.jsxIdentifier(""+e),[],!0),null,[],!0)},w=function(e,n){try{return e.scope.bindings[n].path}catch(e){return}},P=(process.env.INJECT_COMPONENT_ALIAS||"").toLocaleLowerCase(),A=function(e,n){var t;if((l.isJSXElement(e)||l.isJSXFragment(e))&&!b[(null==(t=e.node)||null==(t=t.openingElement)||null==(t=t.name)?void 0:t.name)||""]){!function(e){var n=l.jsxElement(l.jsxOpeningElement(l.jsxIdentifier("View"),[]),l.jsxClosingElement(l.jsxIdentifier("View")),[e.node]);e.replaceWith(n)}(e);for(var r,i=m(n);!(r=i()).done;){var o=r.value;"top"===o.injectPosition?e.node.children.unshift(O(o.tagName)):e.node.children.push(O(o.tagName))}}},N=function(e,n,t){var r;if("createElement"!==(null==(r=e.node)||null==(r=r.callee)||null==(r=r.property)?void 0:r.name)){var i,o,a,s,c=e.get("callee").get("body");c.isBlockStatement()?T(c,n,t):A(c,n)}else for(var u,p=e.node.arguments,f=m(n);!(u=f()).done;)p.push((i=u.value.tagName,o=l.identifier("React"),a=l.identifier("createElement"),s=l.memberExpression(o,a),l.callExpression(s,[l.identifier(i)])))},C=function e(n,t,r,i){if(n){if(l.isJSXElement(n)||l.isJSXFragment(n))return A(n,t),void(i&&i());if(l.isConditionalExpression(n)){var o=n.get("consequent"),a=n.get("alternate");return e(o,t,r,i),void e(a,t,r,i)}if(l.isCallExpression(n))return N(n,t,r),void(i&&i());if(l.isObjectExpression(n))return A(n,t),void(i&&i());if(l.isLogicalExpression(n)){var s=n.get("left"),c=n.get("right");return e(s,t,r,i),void e(c,t,r,i)}l.isTSAsExpression(n)?I(n,t,r):l.isIdentifier(n)?k(n,t,r):l.isVariableDeclarator(n)&&q(n,t,r)}},T=function e(n,t,r){try{var i=!1;n.get("body").get("body").forEach((function(n){if(l.isReturnStatement(n)&&!i){i=!0,n.node.__GLOBAL__COMPONENT__="__GLOBAL__COMPONENT__";var o=n.get("argument");C(o,t,r,(function(){n.skip()}))}l.isIfStatement(n)&&e(n,t,r)}))}catch(e){}},I=function(e,n,t){var r;return null!=(r=e.node)&&null!=(r=r.expression)&&r.name?D(w(e,e.node.expression.name),n,t):C(e.get("expression"),n,t)},k=function(e,n,t){return D(w(e,e.node.name),n,t)},q=function(e,n,t){var r=e.get("init");return D(r,n,t)},D=function(e,n,t){if(e&&e.node)switch(e.node.type){case"Identifier":k(e,n,t);break;case"VariableDeclarator":q(e,n,t);break;case"ArrowFunctionExpression":!function(e,n,t){var r=e.get("body");l.isBlockStatement(r.node)?T(e,n,t):l.isCallExpression(r.node)?D(e,n,t):A(r,n)}(e,n,t);break;case"FunctionDeclaration":case"FunctionExpression":T(e,n,t);break;case"TSAsExpression":I(e,n,t);break;case"ClassDeclaration":case"ClassExpression":!function(e,n,t){u(e.node,{ClassMethod:function(e){var r;"render"===(null==(r=e.node.key)?void 0:r.name)&&(T(e,n,t),e.stop())}},e.scope,e)}(e,n,t);break;case"CallExpression":N(e,n,t);break;case"JSXElement":A(e,n)}},L=new Map,M=new Map;exports.default=function(e){var r=n.getOptions(this);if(!r||"Object"===Object.prototype.toString.call(r).slice(8,-1)){r=f({},g,r);var i=this.resourcePath,l=this._module,d=void 0===l?{}:l,b=M.get(i)||{},O=d.miniType||b.miniType,w=d.name||b.name;if(!O)return e;if([t.META_TYPE.PAGE].includes(O)){var A;M.set(i,{miniType:O,name:w});var N=null==(A=this._compiler.options)||null==(A=A.resolve)?void 0:A.alias;try{return function(e,n,r,i,l){if(!n.enable)return e;if(e.includes("/*#__PURE__*/")||e.includes("react/jsx-runtime"))return e;var d=E(e);if(L.get(d))return L.get(d);if(h(n.excludePages,i))return e;if(!j(n.includePages,i))return e;if(!v){var g=function(e,n){if(!o.existsSync(e))return[];var t=o.readdirSync(e),r=[];r.__import_path__={};for(var i,s=m(t);!(i=s()).done;){var c=i.value,u=a.join(e,c);if(o.statSync(u).isDirectory()){var l=a.join(u,"config.json"),p=a.join(u,"config."+P+".json"),d=f({},x);try{if(!o.existsSync(p)){if(!o.existsSync(l))throw new Error("组件配置不存在");p=l}var v=JSON.parse(o.readFileSync(p,{encoding:"utf-8"}));Object.assign(d,v)}catch(e){console.error(e)}d.tagName=S(d.tagName||c),d.tagName="Inject_"+d.tagName,d.entry=a.normalize(a.join(u,d.entry));var g=a.parse(d.entry),b=!1;if(!g.name.split(".")[1]&&y){g.name=g.name+"."+y,delete g.base;var h=a.format(g);o.existsSync(h)&&(d.entry=h,b=!0)}(b||o.existsSync(d.entry))&&!_(d,n)&&d.enable&&(r.push(f({},d)),r.__import_path__[d.entry]=d)}}return r}(n.componentsPath||"",i);v=g}if(!v.length)return e;var b=function(e){return c.parse(e,{sourceType:"module",ranges:!0,plugins:["jsx","typescript","classProperties"]})}(e),O=function(e){var n;return u(e,{ExportDefaultDeclaration:function(e){n=e,e.stop()}}),n}(b);if(!O)return t.printLog("warning","找不到默认导出,页面组件应通过全局默认导出(export default XX)，该页( "+i+" )将跳过自动插入全局组件",r),e;var w=function(e,n,t,r){var i=Object.assign({},t.__import_path__),s=t.length;u(e,{ImportDeclaration:function(e){var t=function(e,n,t){var r,i=e;if(a.isAbsolute(e))i=e;else if(/^\.{1,2}\//.test(e))i=a.resolve(((r=n.split(a.sep)).pop(),r.join(a.sep)),e);else for(var s,c=m(t);!(s=c()).done;){var u=s.value,l=u[0],p=u[1];if(e.startsWith(l)){i=e.replace(l,p);break}}return i=a.normalize(i),a.parse(i).ext?i:o.existsSync(i+"."+y+".tsx")?i+"."+y+".tsx":o.existsSync(i+".tsx")?i+".tsx":o.existsSync(""+i+a.sep+"index."+y+".tsx")?""+i+a.sep+"index."+y+".tsx":o.existsSync(i+a.sep+"index.tsx")?i+a.sep+"index.tsx":o.existsSync(i+"."+y+".jsx")?i+"."+y+".jsx":o.existsSync(i+".jsx")?i+".jsx":o.existsSync(""+i+a.sep+"index."+y+".jsx")?""+i+a.sep+"index."+y+".jsx":o.existsSync(i+a.sep+"index.jsx")?i+a.sep+"index.jsx":i}(e.node.source.value,n,r);i[t]&&(delete i[t],s--),s<=0&&e.stop()}});var c=Object.values(i);return c.__import_path__=i,c}(b,r,v,Object.entries(l));!function(e){var n=!1;if(u(e,{ImportDeclaration:function(e){var t;if("@tarojs/components"===e.node.source.value)if(n=!0,null==(t=e.node.specifiers)?void 0:t.find((function(e){return"View"===e.local.name})))e.stop();else{var r=e.node.specifiers.map((function(e){return e.local.name}));r.push("View");var i=p.ast("import {"+r.join(",")+"} from '@tarojs/components'");e.replaceWith(i),e.stop()}}}),!n){var t=p.ast("import { View } from '@tarojs/components'");e.program.body.unshift(t)}}(b),function(e,n){for(var r,i=m(n);!(r=i()).done;){var o=r.value;try{var s=o.entry.split(a.sep).join("/"),c=p.ast("import "+o.tagName+" from '"+s+"';");e.program.body.unshift(c)}catch(e){t.printLog("error","注入 "+o.tagName+" 组件失败: "+e)}}}(b,w),D(O.get("declaration"),w,r);var A=function(e){return s(e).code}(b),N=E(A);return L.set(N,A),L.set(d,A),A}(e,r,i,w,N)}catch(n){return console.log(n),e}}return e}t.printLog("error","\n❌ 全局注入插件加载失败 :: options 必须为 Object 类型")};
//# sourceMappingURL=taro-loader-component-inject.cjs.production.min.js.map
